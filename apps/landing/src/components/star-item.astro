---
import { getRandomNumber } from "../utils";
import { getRelativeLocaleUrl } from "astro:i18n";
interface Props {
    itemId: number;
    isActive?: boolean;
    isHidden?: boolean;
    top?: string;
    left?: string;
    radius?: number;
    label?: string;
    color?: string;
    href?: string;
    coordinates: {
        x: number;
        y: number;
    };
}

const {
    color = "black",
    coordinates,
    href = "/",
    isActive = false,
    isHidden = true,
    itemId,
    label = "",
    left = "0",
    radius = 10,
    top = "0",
} = Astro.props;

const innerSize = `${radius}px`;
const outerSize = `${radius + 5}px`;
const pulsarId = `outer-pulsar-${itemId}`;
const containerId = `star-item-container-${itemId}`;
const delay = getRandomNumber(0, 3000);
const destination = {
    x: label ? getRandomNumber(-200, -100) : getRandomNumber(-300, 300),
    y: label ? getRandomNumber(-200, -100) : getRandomNumber(-300, 300),
};
const currentLocale = Astro.currentLocale ?? "en";
---

<div
    class:list={[
        "absolute transition-[visibility,opacity] duration-500 ease-linear translate-6",
        isHidden ? "invisible opacity-0" : "visible opacity-100",
    ]}
    id={containerId}
    style={{
        top,
        left,
        color,
    }}
>
    <div class="relative">
        <div
            class="absolute rounded-full"
            style={{
                width: innerSize,
                height: innerSize,
                backgroundColor: color,
            }}
        >
        </div>
        <div
            id={pulsarId}
            class="absolute rounded-full opacity-30"
            style={{
                width: outerSize,
                height: outerSize,
                backgroundColor: color,
            }}
        >
        </div>
        {
            label && (
                <div
                    class:list={[
                        "absolute top-[30px] transition-transform duration-200 ease-in",
                        isActive && "text-white scale-150",
                    ]}
                >
                    <div class="relative">
                        <a href={getRelativeLocaleUrl(currentLocale, href)}>
                            <span class="absolute uppercase font-mono font-black tracking-[3px] text-pink-500">
                                {label}
                            </span>
                        </a>
                    </div>
                </div>
            )
        }
    </div>
</div>

<script define:vars={{ pulsarId, delay, containerId, label, destination }} is:inline>
    document.addEventListener("DOMContentLoaded", () => {
        const PADDING = 20;
        // @ts-expect-error: pulsarId is defined
        const tooltipLabel = document.querySelector(`#${pulsarId} + div span`);

        if (tooltipLabel) {
            const rect = tooltipLabel.getBoundingClientRect();
            if (rect.right >= window.innerWidth) {
                tooltipLabel.style.left = `-${rect.right - window.innerWidth + PADDING}px`;
            }
        }

        // Animation using Web Animations API instead of motion library

        // @ts-expect-error: containerId is defined
        const container = document.getElementById(containerId);

        if (container) {
            container.animate([{ transform: `translate(${destination.x}px, ${destination.y}px)` }], {
                delay,
                duration: 85000,
                easing: "ease-out",
                iterations: Infinity,
            });
        }

        // @ts-expect-error: pulsarId is defined
        const pulsar = document.getElementById(pulsarId);
        setTimeout(() => {
            if (pulsar) {
                pulsar.animate(
                    [
                        { transform: "scale(1)", opacity: 0.3 },
                        { transform: "scale(1.9)", opacity: 0 },
                    ],
                    {
                        delay,
                        duration: 2000,
                        easing: "ease-out",
                        iterations: Infinity,
                    },
                );
            }
        }, delay);
    });
</script>
